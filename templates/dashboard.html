{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block topbar_actions %}
  <a href="/tickets/create" class="btn btn-primary">ï¼‹ New Ticket</a>
{% endblock %}

{% block content %}

<div class="page-header">
  <div>
    <div class="page-title">Dashboard</div>
    <div class="page-subtitle">
      {% if current_user.role == "SUPER_ADMIN" %}
        Organisation-wide overview â€” all departments
      {% elif current_user.role == "ADMIN" %}
        {{ current_user.department }} department overview
      {% else %}
        Your ticket activity
      {% endif %}
    </div>
  </div>
  {% if current_user.role in ["ADMIN", "SUPER_ADMIN"] %}
  <a href="/report" class="btn btn-outline">â†“ Export Report</a>
  {% endif %}
</div>

<!-- STAT CARDS -->
<div style="display:grid; grid-template-columns:repeat(6,1fr); gap:14px; margin-bottom:24px;">

  <div class="card" style="padding:18px 16px;">
    <div style="font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Total</div>
    <div style="font-size:28px;font-weight:800;letter-spacing:-1px;line-height:1;">{{ total_tickets }}</div>
  </div>

  <div class="card" style="padding:18px 16px; border-top:3px solid var(--amber);">
    <div style="font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Open</div>
    <div style="font-size:28px;font-weight:800;letter-spacing:-1px;line-height:1;color:var(--amber);">{{ open_tickets }}</div>
  </div>

  <div class="card" style="padding:18px 16px; border-top:3px solid var(--blue);">
    <div style="font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">In Progress</div>
    <div style="font-size:28px;font-weight:800;letter-spacing:-1px;line-height:1;color:var(--blue);">{{ in_progress }}</div>
  </div>

  <div class="card" style="padding:18px 16px; border-top:3px solid var(--green);">
    <div style="font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Resolved</div>
    <div style="font-size:28px;font-weight:800;letter-spacing:-1px;line-height:1;color:var(--green);">{{ resolved }}</div>
  </div>


  <div class="card" style="padding:18px 16px; border-top:3px solid var(--red);">
    <div style="font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Overdue</div>
    <div style="font-size:28px;font-weight:800;letter-spacing:-1px;line-height:1;color:var(--red);">{{ overdue }}</div>
  </div>

</div>

<!-- MIDDLE PANELS -->
<div style="display:grid; grid-template-columns:{% if current_user.role == 'SUPER_ADMIN' %}1fr 1fr 1.4fr{% else %}1fr 1.8fr{% endif %}; gap:16px; margin-bottom:20px;">

  <!-- Priority -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">Tickets by Priority</div>
    </div>
    <div style="padding:4px 0;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:13px 20px;border-bottom:1px solid var(--border);">
        <div style="display:flex;align-items:center;gap:9px;font-size:13px;font-weight:600;">
          <span style="width:9px;height:9px;border-radius:50%;background:var(--red);display:inline-block;flex-shrink:0;"></span> Critical
        </div>
        <div style="font-size:20px;font-weight:800;color:var(--red);">{{ priority_counts["CRITICAL"] }}</div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:13px 20px;border-bottom:1px solid var(--border);">
        <div style="display:flex;align-items:center;gap:9px;font-size:13px;font-weight:600;">
          <span style="width:9px;height:9px;border-radius:50%;background:var(--amber);display:inline-block;flex-shrink:0;"></span> Essential
        </div>
        <div style="font-size:20px;font-weight:800;color:var(--amber);">{{ priority_counts["ESSENTIAL"] }}</div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:13px 20px;">
        <div style="display:flex;align-items:center;gap:9px;font-size:13px;font-weight:600;">
          <span style="width:9px;height:9px;border-radius:50%;background:var(--light);display:inline-block;flex-shrink:0;"></span> Desirable
        </div>
        <div style="font-size:20px;font-weight:800;">{{ priority_counts["DESIRABLE"] }}</div>
      </div>
    </div>
  </div>

  <!-- Department (super admin only) -->
  {% if current_user.role == "SUPER_ADMIN" %}
  <div class="card">
    <div class="card-header">
      <div class="card-title">Tickets by Department</div>
    </div>
    <div style="padding:4px 0;">
    {% for dept, color in [("IT","var(--blue)"),("HR","var(--violet)"),("MAINTENANCE","var(--green)"),("OTHER","var(--muted)")] %}
      <a href="/tickets?department={{ dept }}"
         style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:{% if not loop.last %}1px solid var(--border){% else %}none{% endif %};text-decoration:none;transition:background 0.13s;"
         onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
          <div style="display:flex;align-items:center;gap:9px;font-size:13px;font-weight:600;color:var(--text);">
          <span style="width:9px;height:9px;border-radius:50%;background:{{ color }};display:inline-block;flex-shrink:0;"></span>
          {{ dept }}
          </div>
        <div style="font-size:20px;font-weight:800;color:{{ color }};">{{ department_counts[dept] }}</div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Recent Activity -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">Recent Activity</div>
      <span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);"></span>
    </div>
    <div>
      {% if recent_activity %}
        {% for activity in recent_activity %}
        <div style="display:flex;align-items:flex-start;gap:12px;padding:12px 20px;border-bottom:{% if not loop.last %}1px solid var(--border){% else %}none{% endif %};">
          <div style="width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;
            {% if activity.action == 'CREATED' %}background:var(--green-soft);
            {% elif activity.action == 'STATUS_UPDATED' %}background:var(--blue-soft);
            {% elif activity.action == 'COMMENT_ADDED' %}background:var(--violet-soft);
            {% else %}background:var(--green-soft);{% endif %}">
            {% if activity.action == "CREATED" %}ðŸ†•
            {% elif activity.action == "STATUS_UPDATED" %}ðŸ”„
            {% elif activity.action == "COMMENT_ADDED" %}ðŸ’¬
            {% elif activity.action == "ACKNOWLEDGED" %}âœ…
            {% else %}â€¢{% endif %}
          </div>
          <div>
            <div style="font-size:13px;font-weight:500;color:var(--text2);">
              {% if activity.action == "CREATED" %}Ticket #{{ activity.ticket_id }} created
              {% elif activity.action == "STATUS_UPDATED" %}Ticket #{{ activity.ticket_id }}: {{ activity.old_value }} â†’ {{ activity.new_value }}
              {% elif activity.action == "COMMENT_ADDED" %}Ticket #{{ activity.ticket_id }}: COO added a remark
              {% elif activity.action == "ACKNOWLEDGED" %}Ticket #{{ activity.ticket_id }} acknowledged by staff
              {% else %}{{ activity.action }}{% endif %}
            </div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px;font-family:'DM Mono',monospace;">
              {{ activity.timestamp | ist }}
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">ðŸ“‹</div>
          <p>No recent activity</p>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- MAINTENANCE TASK SUMMARY â€” shown to MAINTENANCE admin and SUPER_ADMIN -->
{% if tasks_summary is not none %}
<div style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
  <div style="font-size:15px;font-weight:800;letter-spacing:-0.3px;">ðŸ”§ Maintenance Task Tracker</div>
  <a href="/tasks" class="btn btn-outline btn-sm">View All Tasks â†’</a>
</div>

<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:16px;">
  <div class="card" style="padding:16px;">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-bottom:8px;">Total</div>
    <div style="font-size:24px;font-weight:800;">{{ tasks_summary.total }}</div>
  </div>
  <div class="card" style="padding:16px;border-top:3px solid var(--amber);">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-bottom:8px;">Pending</div>
    <div style="font-size:24px;font-weight:800;color:var(--amber);">{{ tasks_summary.pending }}</div>
  </div>
  <div class="card" style="padding:16px;border-top:3px solid var(--blue);">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-bottom:8px;">In Progress</div>
    <div style="font-size:24px;font-weight:800;color:var(--blue);">{{ tasks_summary.in_progress }}</div>
  </div>
  <div class="card" style="padding:16px;border-top:3px solid var(--green);">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-bottom:8px;">Completed</div>
    <div style="font-size:24px;font-weight:800;color:var(--green);">{{ tasks_summary.completed }}</div>
  </div>
  <div class="card" style="padding:16px;border-top:3px solid var(--red);">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-bottom:8px;">Overdue</div>
    <div style="font-size:24px;font-weight:800;color:var(--red);">{{ tasks_summary.overdue }}</div>
  </div>
</div>

<!-- UPCOMING TASKS TABLE -->
<div class="card" style="margin-bottom:24px;">
  <div class="card-header">
    <div class="card-title">Upcoming Tasks</div>
    <div class="card-subtitle">Next 5 tasks approaching deadline</div>
  </div>
  {% if tasks_summary.upcoming %}
  <table class="data-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Title</th>
        <th>Assigned To</th>
        <th>Status</th>
        <th>Deadline</th>
        <th>Alert Email</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks_summary.upcoming %}
      {% set days_left = (task.deadline - now).days %}
      <tr>
        <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--blue);">#{{ '%03d' % task.id }}</td>
        <td style="font-weight:600;">{{ task.title }}</td>
        <td>{{ task.assigned_to }}</td>
        <td>
          {% if task.status == "PENDING" %}<span class="pill pill-open">Pending</span>
          {% elif task.status == "IN_PROGRESS" %}<span class="pill pill-progress">In Progress</span>
          {% else %}<span class="pill pill-resolved">Completed</span>{% endif %}
        </td>
        <td>
          <span style="font-family:'DM Mono',monospace;font-size:12px;
            {% if days_left <= 1 %}color:var(--red);font-weight:700;
            {% elif days_left <= 3 %}color:var(--amber);font-weight:600;
            {% else %}color:var(--muted);{% endif %}">
            {{ task.deadline | ist }}
            {% if days_left == 0 %}<span style="font-size:10px;background:var(--red-soft);color:var(--red);padding:1px 6px;border-radius:4px;margin-left:4px;font-weight:700;">TODAY</span>
            {% elif days_left == 1 %}<span style="font-size:10px;background:var(--amber-soft);color:var(--amber);padding:1px 6px;border-radius:4px;margin-left:4px;font-weight:700;">TOMORROW</span>
            {% endif %}
          </span>
        </td>
        <td style="font-size:12px;color:var(--muted);">{{ task.notify_email }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state" style="padding:28px;">
    <div class="empty-icon">âœ…</div>
    <p>No upcoming tasks â€” all clear.</p>
  </div>
  {% endif %}
</div>
{% endif %}

{% endblock %}